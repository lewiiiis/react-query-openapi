"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var t=e(require("lodash/debounce")),r=e(require("lodash/isEqual")),n=require("react"),o=e(require("lodash/noop")),a=e(require("url")),s=e(require("qs")),i=e(require("lodash/merge")),u=e(require("react-fast-compare")),l=e(require("lodash/isEqualWith"));function c(){return(c=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)}function p(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,(Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function f(e,t){try{var r=e()}catch(e){return t(e)}return r&&r.then?r.then(void 0,t):r}"undefined"!=typeof Symbol&&(Symbol.iterator||(Symbol.iterator=Symbol("Symbol.iterator"))),"undefined"!=typeof Symbol&&(Symbol.asyncIterator||(Symbol.asyncIterator=Symbol("Symbol.asyncIterator")));var h=n.createContext({base:"",parentPath:"",resolve:function(e){return e},requestOptions:{},onError:o,onRequest:o,onResponse:o,queryParams:{},queryParamStringifyOptions:{}}),d=function(e){function t(){return e.apply(this,arguments)||this}return p(t,e),t.prototype.render=function(){var e=this.props,t=e.children,r=function(e,t){if(null==e)return{};var r,n,o={},a=Object.keys(e);for(n=0;n<a.length;n++)t.indexOf(r=a[n])>=0||(o[r]=e[r]);return o}(e,["children"]);return n.createElement(h.Provider,{value:c({onError:o,onRequest:o,onResponse:o,resolve:function(e){return e},requestOptions:{},parentPath:"",queryParams:{},queryParamStringifyOptions:{}},r)},t)},t}(n.Component);d.displayName="RestfulProviderContext";var y=h.Consumer,m=function(e,t,r){void 0===e&&(e=""),void 0===t&&(t=""),void 0===r&&(r="");var n=v(t,r);return""===e&&n.startsWith("/")?n:e.endsWith("/")?""+e.slice(0,-1)+n:""+e+n},v=function(e,t){return void 0===e&&(e=""),void 0===t&&(t=""),t.startsWith("/")&&t.length>1?a.resolve(e,t):""!==t&&"/"!==t?e+"/"+t:e},g=function(e){try{return 204===e.status?Promise.resolve({data:void 0,responseError:!1}):(e.headers.get("content-type")||"").includes("application/json")?Promise.resolve(f((function(){return Promise.resolve(e.json()).then((function(e){return{data:e,responseError:!1}}))}),(function(e){return{data:e.message,responseError:!0}}))):(e.headers.get("content-type")||"").includes("text/plain")||(e.headers.get("content-type")||"").includes("text/html")?Promise.resolve(f((function(){return Promise.resolve(e.text()).then((function(e){return{data:e,responseError:!1}}))}),(function(e){return{data:e.message,responseError:!0}}))):Promise.resolve({data:e,responseError:!1})}catch(e){return Promise.reject(e)}};function P(e,t,r,n){void 0===n&&(n={});var o=n.queryParamOptions,i=n.stripTrailingSlash,u=e.endsWith("/")?e:e+"/",l=t.startsWith("/")?t.slice(1):t,c=Object.keys(r||{}).length?l+"?"+s.stringify(r,o):l,p=Boolean(c)?a.resolve(u,c):u;return i&&p.endsWith("/")?p.slice(0,-1):p}var b=function(e){function o(r){var n;return(n=e.call(this,r)||this).abortController=new AbortController,n.signal=n.abortController.signal,n.state={data:null,response:null,loading:!n.props.lazy,error:null},n.getRequestOptions=function(e,t,r){try{var o=!1,a=function(e){return o?e:c({},t,s,{headers:new Headers(c({},"boolean"!=typeof r?r:{},(t||{}).headers,(s||{}).headers))})},s=n.props.requestOptions,i=function(){if("function"==typeof s)return Promise.resolve(s(e,"GET")).then((function(e){return o=!0,c({},t,e,{headers:new Headers(c({},"boolean"!=typeof r?r:{},(t||{}).headers,e.headers))})}))}();return Promise.resolve(i&&i.then?i.then(a):a(i))}catch(e){return Promise.reject(e)}},n.fetch=function(e,t){try{var r=n.props,o=r.base,a=r.__internal_hasExplicitBase,s=r.parentPath,i=r.path,u=r.resolve,l=r.onError,c=r.onRequest,p=r.onResponse;!n.state.error&&n.state.loading||n.setState((function(){return{error:null,loading:!0}}));var h=function(){var e=a?i:v(s,i);return P(o,e,n.props.queryParams,{stripTrailingSlash:!0,queryParamOptions:n.props.queryParamStringifyOptions})};return Promise.resolve(n.getRequestOptions(h(),t)).then((function(r){var o=new Request(h(),r);return c&&c(o),f((function(){return Promise.resolve(fetch(o,{signal:n.signal})).then((function(r){var o=r.clone();return p&&p(r.clone()),Promise.resolve(g(r)).then((function(a){var s=a.data,i=a.responseError;if(!n.signal.aborted){if(!r.ok||i){var c={message:"Failed to fetch: "+r.status+" "+r.statusText+(i?" - "+s:""),data:s,status:r.status};return n.setState({loading:!1,error:c,data:null,response:o}),!n.props.localErrorOnly&&l&&l(c,(function(){return n.fetch(e,t)}),r),null}return Promise.resolve(function(e){var t=e.data,r=e.resolve;try{var n=function(){return{data:o,error:a}},o=null,a=null,s=f((function(){var e=function(){if(r){var e=function(e){o=e},n=r(t);return n.then?Promise.resolve(n).then(e):e(n)}o=t}();if(e&&e.then)return e.then((function(){}))}),(function(e){o=null,a={message:"RESOLVE_ERROR",data:JSON.stringify(e)}}));return Promise.resolve(s&&s.then?s.then(n):n())}catch(e){return Promise.reject(e)}}({data:s,resolve:u})).then((function(e){return n.setState({loading:!1,data:e.data,error:e.error,response:o}),s}))}}))}))}),(function(e){n.signal.aborted||n.setState({loading:!1,data:null,error:{message:"Failed to fetch: "+e.message,data:e}})}))}))}catch(e){return Promise.reject(e)}},"object"==typeof r.debounce?n.fetch=t(n.fetch,r.debounce.wait,r.debounce.options):"number"==typeof r.debounce?n.fetch=t(n.fetch,r.debounce):r.debounce&&(n.fetch=t(n.fetch)),n}p(o,e);var a=o.prototype;return a.componentDidMount=function(){this.props.lazy||this.fetch()},a.componentDidUpdate=function(e){var t=e.resolve,n=e.requestOptions;(e.base!==this.props.base||e.parentPath!==this.props.parentPath||e.path!==this.props.path||!r(e.queryParams,this.props.queryParams)||t&&this.props.resolve&&t.toString()!==this.props.resolve.toString()||n&&this.props.requestOptions&&n.toString()!==this.props.requestOptions.toString())&&(this.props.lazy||this.fetch())},a.componentWillUnmount=function(){this.abortController.abort()},a.render=function(){var e=this.props,t=e.children,r=e.path,o=e.base,a=e.parentPath,s=this.state,i=s.data,u=s.error,l=s.loading,c=s.response;return e.wait&&null===i&&!u?n.createElement(n.Fragment,null):t(i,{loading:l,error:u},{refetch:this.fetch},{response:c,absolutePath:m(o,a,r)})},o}(n.Component);function q(e){return n.createElement(y,null,(function(t){return n.createElement(d,Object.assign({},t,{parentPath:v(t.parentPath,e.path)}),n.createElement(b,Object.assign({},t,e,{queryParams:c({},t.queryParams,e.queryParams),__internal_hasExplicitBase:Boolean(e.base),queryParamStringifyOptions:c({},t.queryParamStringifyOptions,e.queryParamStringifyOptions)})))}))}b.defaultProps={base:"",parentPath:"",resolve:function(e){return e},queryParams:{}};var O=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={data:null,previousData:null,loading:!t.props.lazy,lastResponse:null,polling:!t.props.lazy,finished:!1,error:null},t.keepPolling=!t.props.lazy,t.abortController=new AbortController,t.signal=t.abortController.signal,t.isModified=function(e,r){return 304!==e.status&&!u(t.state.data,r)},t.getRequestOptions=function(e){return"function"==typeof t.props.requestOptions?t.props.requestOptions(e,"GET"):t.props.requestOptions||{}},t.isResponseOk=function(e){return e.ok||304===e.status},t.cycle=function(){try{if(!t.keepPolling)return Promise.resolve();if(t.props.until&&t.props.until(t.state.data,t.state.lastResponse))return t.stop(),Promise.resolve();var e=t.props,r=e.interval,n=e.wait,o=e.onError,a=e.onRequest,s=e.onResponse,i=t.state.lastPollIndex,u=P(e.base,e.path,t.props.queryParams,{queryParamOptions:t.props.queryParamStringifyOptions,stripTrailingSlash:!0});return Promise.resolve(t.getRequestOptions(u)).then((function(e){var l=new Request(u,c({},e,{headers:c({Prefer:"wait="+n+"s;"+(i?"index="+i:"")},e.headers)}));return a&&a(l),f((function(){return Promise.resolve(fetch(l,{signal:t.signal})).then((function(e){return s&&s(e.clone()),Promise.resolve(g(e)).then((function(n){var a=n.data,s=n.responseError;if(t.keepPolling&&!t.signal.aborted){if(!t.isResponseOk(e)||s){var i={message:"Failed to poll: "+e.status+" "+e.statusText+(s?" - "+a:""),data:a,status:e.status};t.setState({loading:!1,lastResponse:e,error:i}),!t.props.localErrorOnly&&o&&o(i,(function(){return Promise.resolve()}),e)}else t.isModified(e,a)&&t.setState((function(t){return{loading:!1,lastResponse:e,previousData:t.data,data:a,error:null,lastPollIndex:e.headers.get("x-polling-index")||void 0}}));return Promise.resolve(new Promise((function(e){return setTimeout(e,r)}))).then((function(){t.cycle()}))}}))}))}),(function(){}))}))}catch(e){return Promise.reject(e)}},t.start=function(){t.keepPolling=!0,t.state.polling||t.setState((function(){return{polling:!0}})),t.cycle()},t.stop=function(){t.keepPolling=!1,t.setState((function(){return{polling:!1,finished:!0}}))},t}p(t,e);var r=t.prototype;return r.componentDidMount=function(){var e=this.props,t=e.lazy;if(void 0===e.path)throw new Error('[restful-react]: You\'re trying to poll something without a path. Please specify a "path" prop on your Poll component.');t||this.start()},r.componentWillUnmount=function(){this.abortController.abort(),this.stop()},r.render=function(){var e=this.state,t=e.lastResponse,r=e.previousData,n=e.data,o=e.polling,a=e.loading,s=e.error,i=e.finished,u=this.props,l=u.children,c=u.resolve,p={response:t,absolutePath:m(u.base,"",u.path)},f={polling:o,loading:a,error:s,finished:i},h={stop:this.stop,start:this.start};return l(t&&c?c(n,r):n,f,h,p)},t}(n.Component);O.defaultProps={interval:1e3,wait:60,base:"",resolve:function(e){return e},queryParams:{}};var E=function(e){function t(){var t;return(t=e.apply(this,arguments)||this).state={loading:!1,error:null},t.abortController=new AbortController,t.signal=t.abortController.signal,t.mutate=function(e,r){try{var n=function(n){function o(o){function a(n){return Promise.resolve(g(s)).then((function(n){var o,a=n.data,i=n.responseError;try{o=b?b(a):a}catch(e){if(t.signal.aborted)return;throw t.setState({error:{data:e.message,message:"Failed to resolve: "+e.message},loading:!1}),e}if(!t.signal.aborted){if(!s.ok||i){var u={data:o,message:"Failed to fetch: "+s.status+" "+s.statusText,status:s.status};throw t.setState({error:u,loading:!1}),!t.props.localErrorOnly&&h&&h(u,(function(){return t.mutate(e,r)}),s),u}return t.setState({loading:!1}),t.props.onMutate&&t.props.onMutate(e,o),o}}))}var s,i=new Request(q(),c({method:l,body:O},n,r,{headers:c({},"function"==typeof p?o.headers:o,r?r.headers:{})}));e instanceof FormData||i.headers.has("content-type")||i.headers.set("content-type","object"==typeof e?"application/json":"text/plain"),d&&d(i);var u=f((function(){return Promise.resolve(fetch(i,{signal:t.signal})).then((function(e){s=e,y&&y(s.clone())}))}),(function(n){var o={message:"Failed to fetch: "+n.message,data:""};throw t.setState({error:o,loading:!1}),!t.props.localErrorOnly&&h&&h(o,(function(){return t.mutate(e,r)})),o}));return u&&u.then?u.then(a):a()}return"function"==typeof p?Promise.resolve("function"==typeof p?p(q(),l,e):(p||{}).headers).then(o):o("function"==typeof p?p(q(),l,e):(p||{}).headers)},o=t.props,a=o.__internal_hasExplicitBase,s=o.base,i=o.parentPath,u=o.path,l=o.verb,p=o.requestOptions,h=o.onError,d=o.onRequest,y=o.onResponse,m=o.pathInlineBodyEncode,b=o.resolve;t.setState((function(){return{error:null,loading:!0}}));var q=function(){var r="DELETE"===l&&"string"==typeof e?v(u,m?m(e):e):u,n=a?r||"":v(i,r);return P(s,n,t.props.queryParams,{stripTrailingSlash:!0,queryParamOptions:t.props.queryParamStringifyOptions})},O=e instanceof FormData?e:"object"==typeof e?JSON.stringify(e):e;return Promise.resolve("function"==typeof p?Promise.resolve("function"==typeof p?p(q(),l,e):p).then(n):n("function"==typeof p?p(q(),l,e):p))}catch(e){return Promise.reject(e)}},t}p(t,e);var r=t.prototype;return r.componentWillUnmount=function(){this.abortController.abort()},r.render=function(){var e=this.props,t=this.state;return(0,e.children)(this.mutate,{loading:t.loading,error:t.error},{absolutePath:m(e.base,e.parentPath,e.path)})},t}(n.Component);function S(e){var t=n.useRef();return l(e,t.current,(function(e,t){if("function"==typeof e&&"function"==typeof t)return e.toString()===t.toString()}))||(t.current=e),t.current}function R(e,t){n.useEffect(e,S(t))}function j(e,t){return n.useCallback(e,S(t))}function x(){try{return new AbortController}catch(e){return}}function w(){var e=n.useRef(x());return{abort:n.useCallback((function(){e&&e.current&&(e.current.abort(),e.current=x())}),[e]),getAbortSignal:function(){var t;return null==e?void 0:null===(t=e.current)||void 0===t?void 0:t.signal}}}E.defaultProps={base:"",parentPath:"",path:"",queryParams:{}};var C=function(e){return"function"==typeof e.cancel&&"function"==typeof e.flush},k={};exports.Get=q,exports.Mutate=function(e){return n.createElement(y,null,(function(t){return n.createElement(d,Object.assign({},t,{parentPath:v(t.parentPath,e.path)}),n.createElement(E,Object.assign({},t,e,{queryParams:c({},t.queryParams,e.queryParams),queryParamStringifyOptions:c({},t.queryParamStringifyOptions,e.queryParamStringifyOptions),__internal_hasExplicitBase:Boolean(e.base)})))}))},exports.Poll=function(e){return n.createElement(y,null,(function(t){return n.createElement(O,Object.assign({},t,e,{queryParams:c({},t.queryParams,e.queryParams),requestOptions:function(r,n){try{var o=function(t){function o(e){return i(t,e)}return"function"==typeof e.requestOptions?Promise.resolve(e.requestOptions(r,n)).then(o):o(e.requestOptions||{})};return Promise.resolve("function"==typeof t.requestOptions?Promise.resolve(t.requestOptions(r,n)).then(o):o(t.requestOptions||{}))}catch(e){return Promise.reject(e)}},queryParamStringifyOptions:c({},t.queryParamStringifyOptions,e.queryParamStringifyOptions)}))}))},exports.RestfulProvider=d,exports.default=q,exports.useGet=function(){var e="object"==typeof arguments[0]?arguments[0]:c({},arguments[1],{path:arguments[0]}),r=n.useContext(h),o=e.path,a=e.pathParams,s=void 0===a?{}:a,u=n.useState({data:null,response:null,loading:!e.lazy,error:null}),l=u[0],p=u[1],d=w(),y=d.abort,m=d.getAbortSignal,v="function"==typeof o?o(s):o,b=j((function(e,t,r,n){try{var o=function(o){function a(a){var s=n(),u=new Request(S,i({},a,o,{signal:s}));return t.onRequest&&t.onRequest(u),f((function(){return Promise.resolve(fetch(u)).then((function(o){var a=o.clone();return t.onResponse&&t.onResponse(a),Promise.resolve(g(o)).then((function(i){var u=i.data,l=i.responseError;if(!s||!s.aborted){if(!o.ok||l){var f={message:"Failed to fetch: "+o.status+" "+o.statusText+(l?" - "+u:""),data:u,status:o.status};return p((function(e){return c({},e,{loading:!1,data:null,error:f,response:a})})),void(!e.localErrorOnly&&t.onError&&t.onError(f,(function(){return b(e,t,r,n)}),o))}var d=h(u);return p((function(e){return c({},e,{error:null,loading:!1,data:d,response:a})})),d}}))}))}),(function(o){if(!s||!s.aborted){var a={message:"Failed to fetch: "+o.message,data:o.message};p((function(e){return c({},e,{data:null,loading:!1,error:a})})),!e.localErrorOnly&&t.onError&&t.onError(a,(function(){return b(e,t,r,n)}))}}))}return"function"==typeof t.requestOptions?Promise.resolve(t.requestOptions(S,"GET")).then(a):a(t.requestOptions)},a=e.base,s=void 0===a?t.base:a,u=e.path,l=e.resolve,h=void 0===l?t.resolve||function(e){return e}:l,d=e.queryParams,y=void 0===d?{}:d,m=e.queryParamStringifyOptions,v=void 0===m?{}:m,q=e.requestOptions,O=e.pathParams,E=void 0===O?{}:O;p((function(e){return e.error||!e.loading?c({},e,{error:null,loading:!0}):e}));var S=P(s,"function"==typeof u?u(E):u,c({},t.queryParams,y),{queryParamOptions:c({},t.queryParamStringifyOptions,v)});return Promise.resolve("function"==typeof q?Promise.resolve("function"==typeof q?q(S,"GET"):q).then(o):o("function"==typeof q?q(S,"GET"):q))}catch(e){return Promise.reject(e)}}),[e.lazy,e.mock,e.path,e.base,e.resolve,e.queryParams,e.requestOptions,e.pathParams,r.base,r.parentPath,r.queryParams,r.requestOptions,y]),q=n.useCallback("object"==typeof e.debounce?t(b,e.debounce.wait,e.debounce.options):"number"==typeof e.debounce?t(b,e.debounce):e.debounce?t(b):b,[b,e.debounce]);n.useEffect((function(){return e.lazy||e.mock||q(e,r,y,m),function(){C(q)&&q.cancel(),y()}}),[q,e.lazy,e.mock]);var O=n.useCallback((function(t){return void 0===t&&(t={}),q(c({},e,t),r,y,m)}),[q]);return c({},l,e.mock,{absolutePath:P(e.base||r.base,v,c({},r.queryParams,e.queryParams),{queryParamOptions:c({},r.queryParamStringifyOptions,e.queryParamStringifyOptions)}),cancel:function(){p(c({},l,{loading:!1})),y()},refetch:O})},exports.useMutate=function(){var e="object"==typeof arguments[0]?arguments[0]:c({},arguments[2],{path:arguments[1],verb:arguments[0]}),t=n.useContext(h),r=e.verb,o=e.base,a=void 0===o?t.base:o,s=e.path,u=e.queryParams,l=void 0===u?k:u,p=e.resolve,d=void 0===p?t.resolve:p,y=e.pathParams,m=void 0===y?k:y,v="DELETE"===r,b=n.useState({error:null,loading:!1}),q=b[0],O=b[1],E=w(),S=E.abort,x=E.getAbortSignal;n.useEffect((function(){return function(){return S()}}),[S]);var C=e.pathInlineBodyEncode,_=e.queryParamStringifyOptions,T=e.requestOptions,F=e.localErrorOnly,D=e.onMutate,z=[s,m,l,r,v,a,t,_,T,D,S,C,F,d],M=j((function(e,n){try{var o=function(o){function a(r){function a(r){return Promise.resolve(g(s)).then((function(r){var n,o=r.data,a=r.responseError;try{n=d?d(o):o}catch(e){if(u&&u.aborted)return;var i={data:e.message,message:"Failed to resolve: "+e.message};throw O((function(e){return c({},e,{error:i,loading:!1})})),e}if(!u||!u.aborted){if(!s.ok||a){var l={data:n,message:"Failed to fetch: "+s.status+" "+s.statusText,status:s.status};throw O((function(e){return c({},e,{error:l,loading:!1})})),!F&&t.onError&&t.onError(l,(function(){return M(e)}),s),l}return O((function(e){return c({},e,{loading:!1})})),D&&D(e,n),n}}))}var s,l=new Request(b,i({},r,h,o,n,{signal:u}));t.onRequest&&t.onRequest(l);var p=f((function(){return Promise.resolve(fetch(l)).then((function(e){s=e,t.onResponse&&t.onResponse(s.clone())}))}),(function(r){var o={message:"Failed to fetch: "+r.message,data:""};throw O({error:o,loading:!1}),!F&&t.onError&&t.onError(o,(function(){return M(e,n)})),o}));return p&&p.then?p.then(a):a()}return"function"==typeof t.requestOptions?Promise.resolve(t.requestOptions(b,r,e)).then(a):a(t.requestOptions)},u=x();O((function(e){return e.error||!e.loading?c({},e,{loading:!0,error:null}):e}));var p=["function"==typeof s?s((null==n?void 0:n.pathParams)||m):s],h={method:r};if(e instanceof FormData||(h.headers={"content-type":"object"==typeof e?"application/json":"text/plain"}),e instanceof FormData)h.body=e;else if("object"==typeof e)h.body=JSON.stringify(e);else if(v&&void 0!==e){var y=C?C(String(e)):String(e);p.push(y)}else h.body=e;var b=P(a,p.join("/"),c({},t.queryParams,l,null==n?void 0:n.queryParams),{queryParamOptions:c({},t.queryParamStringifyOptions,_)});return Promise.resolve("function"==typeof T?Promise.resolve("function"==typeof T?T(b,r,e):T).then(o):o("function"==typeof T?T(b,r,e):T))}catch(e){return Promise.reject(e)}}),z);return R((function(){q.loading&&S()}),z),c({},q,{mutate:M},e.mock,{cancel:function(){O((function(e){return c({},e,{loading:!1})})),S()}})};
//# sourceMappingURL=restful-react.cjs.production.min.js.map
